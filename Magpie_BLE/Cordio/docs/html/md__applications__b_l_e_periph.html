<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cordio: BLE_periph</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cordio
   </div>
   <div id="projectbrief">Cordio Bluetooth Low Energy Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__applications__b_l_e_periph.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BLE_periph </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Set the maximum reassembled RX ACL packet length. Minimum value is 27.</p><ul>
<li></li>
</ul>
<p>This is the simplest application that should be used when getting started. It will advertise as "Periph" and accepts connection requests.</p>
<h2>Board Setup</h2>
<p>Before building firmware you must select the correct value for BOARD in project.mk, e.g. "EvKit_V1".</p>
<h3>LEDs</h3>
<p>The red LED will indicate that an error assertion has occurred.</p>
<p>The green LED indicates CPU activity. When the LED is on, the CPU is active, when the LED is off, the CPU is in sleep mode.</p>
<h3>Expected Output</h3>
<p>On startup: </p><div class="fragment"><div class="line">terminal: init</div><div class="line">PeriphHandlerInit</div><div class="line">Calculating database hash</div><div class="line">Periph got evt 119</div><div class="line">Periph got evt 32</div><div class="line">&gt;&gt;&gt; Reset complete &lt;&lt;&lt;</div><div class="line">dmAdvActConfig: state: 0</div><div class="line">dmAdvActSetData: state: 0</div><div class="line">dmAdvActStart: state: 0</div><div class="line">HCI_LE_ADV_ENABLE_CMD_CMPL_CBACK_EVT: state: 3</div><div class="line">dmDevPassEvtToDevPriv: event: 12, param: 33, advHandle: 0</div><div class="line">Periph got evt 33</div><div class="line">&gt;&gt;&gt; Advertising started &lt;&lt;&lt;</div></div><!-- fragment --><p>When a connection has been made. </p><div class="fragment"><div class="line">dmConnIdByBdAddr not found</div><div class="line">dmConnCcbAlloc 1</div><div class="line">dmConnSmExecute event=28 state=0</div><div class="line">dmAdvConnected: state: 1</div><div class="line">dmDevPassEvtToDevPriv: event: 13, param: 34, advHandle: 0</div><div class="line">AttsCccInitTable connId=1</div><div class="line">smpDbGetRecord: connId: 1 type: 1</div><div class="line">smpDbAddDevice</div><div class="line">SmpDbGetFailureCount: connId: 1 count: 0</div><div class="line">smpDbGetRecord: connId: 1 type: 1</div><div class="line">smpDbAddDevice</div><div class="line">SmpDbGetPairingDisabledTime: connId: 1 period: 0 attemptMult: 0</div><div class="line">Periph got evt 39</div><div class="line">&gt;&gt;&gt; Connection opened &lt;&lt;&lt;</div><div class="line">Periph got evt 65</div><div class="line">Periph got evt 87</div><div class="line">attsProcMtuReq features 0x00</div><div class="line">hciCoreTxAclStart len=7</div><div class="line">Periph got evt 22</div><div class="line">connId=1 idleMask=0x0004</div><div class="line">hciCoreTxAclStart len=18</div><div class="line">connId=1 idleMask=0x0004</div><div class="line">hciCoreTxAclStart len=26</div><div class="line">hciCoreTxAclStart len=34                                                                                              </div><div class="line">connId=1 idleMask=0x0004                                                                                              </div><div class="line">hciCoreTxAclStart len=34                                                                                              </div><div class="line">attsCccMainCback connId=1 handle=19                                                                                   </div><div class="line">hciCoreTxAclStart len=5                                                                                               </div><div class="line">hciCoreTxAclStart len=27                                                                                              </div><div class="line">hciCoreTxAclStart len=9                                                                                               </div><div class="line">connId=1 idleMask=0x0004                                                                                              </div><div class="line">hciCoreTxAclStart len=10                                                                                              </div><div class="line">connId=1 idleMask=0x0004                                                                                              </div><div class="line">hciCoreTxAclStart len=9                                                                                               </div><div class="line">attsCccMainCback connId=1 handle=515                                                                                  </div><div class="line">hciCoreTxAclStart len=7                                                                                               </div><div class="line">hciCoreTxAclStart len=14</div></div><!-- fragment --><h3>Commands</h3>
<p>Type the desired command and parameter (if applicable) and press enter to execute the command.</p>
<p><b>help</b> Displays the available commands. <b>echo (on|off)</b> Enables or disables the input echo. On by default. <b>btn (ID) (s|m|l|x)</b> Simulates button presses. Example: "btn 1 s" for a short button press on button 1. <b>pin (ConnID) (Pin Code)</b> Used to input the pairing pin code.</p>
<h3>Push buttons</h3>
<p>Push buttons are not implemented in this example.</p>
<h2>Stack Initialization</h2>
<h2>GAP Peripheral / Slave Role</h2>
<h3>Advertising interval</h3>
<p>The advertising interval is configurable in this structure. We can define multiple interverals, each with their own duration. In this case we will advertise at a short interval (96*0.625ms = 60ms) for 30 seconds. We will then transition to a long interval (1600*0.625 ms = 1000 ms) indefinetly. Longer advertising intervals will conserve power, but increase the latency when communicating with scanning devices or creating connections.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___a_p_p___f_r_a_m_e_w_o_r_k___a_p_i.html#structapp_adv_cfg__t">appAdvCfg_t</a> periphAdvCfg = {</div><div class="line">    { 30000, 0,    0 }, </div><div class="line">    { 96,    1600, 0 }  </div><div class="line">};</div></div><!-- fragment --><p>Applications can also set a definite advertising duration with will cause the device to stop advertising at the end of the duation. The application can restart advertising by calling <a class="el" href="group___a_p_p___f_r_a_m_e_w_o_r_k___a_p_i.html#ga4d8546985d4d8c249e40edf3f19c5dd8" title="Start advertising using the parameters for the given mode. ">AppAdvStart()</a>.</p>
<h3>Advertising data</h3>
<p>Applications can define the advertising data with this structure. This information will be broadcast in every advertising event. Each portion of the advertising data is defined by a length byte, a type byte, and the data. In this case we're advertising the flags that the device is discoverable and BR/EDR (Bluetooth Classic) is not supported. We're also advertising the device name "Periph".</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t periphAdvDataDisc[] = {</div><div class="line">    2, </div><div class="line">    <a class="code" href="group___s_t_a_c_k___d_m___a_p_i.html#gaf3c3b6d41796f171bdf90200c2e18f30">DM_ADV_TYPE_FLAGS</a>, </div><div class="line">    <a class="code" href="group___s_t_a_c_k___d_m___a_p_i.html#gadf0a3c53f3a258baeae1a075c53e510f">DM_FLAG_LE_GENERAL_DISC</a> | </div><div class="line">        <a class="code" href="group___s_t_a_c_k___d_m___a_p_i.html#gaa3832fe0b1e267e352d327f73122a82f">DM_FLAG_LE_BREDR_NOT_SUP</a>,</div><div class="line">    7, </div><div class="line">    <a class="code" href="group___s_t_a_c_k___d_m___a_p_i.html#ga4650b9aa74d8d14895eac4c8d2a7c862">DM_ADV_TYPE_LOCAL_NAME</a>, </div><div class="line">    <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <span class="charliteral">&#39;h&#39;</span></div><div class="line">};</div></div><!-- fragment --><h2>GATT Server</h2>
<h2>MTU size and Throughput</h2>
<p>Each layer of the stack has parameters that will bottleneck the throughput of the system. The ATT layer defines a Maximum Transmission Unit (MTU) to indiate the maximum length of an ATT packet.</p>
<div class="fragment"><div class="line">/*! ATT configurable parameters (increase MTU) </div><div class="line"> * ATT_MAX_TRANS_TIMEOUT = 30 seconds</div><div class="line"> */</div><div class="line">static const attCfg_t periphAttCfg = {</div><div class="line">    15, /* ATT server service discovery connection idle timeout in seconds */</div><div class="line">    241, /* desired ATT MTU */</div><div class="line">    ATT_MAX_TRANS_TIMEOUT, /* transcation timeout in seconds */</div><div class="line">    4 /* number of queued prepare writes supported by server */</div><div class="line">};</div></div><!-- fragment --><p>This MaxRxAclLen defines the maximum reassembled RX Asynchronous Connection-Orientated Logical(ACL) packet length. Packets received at the HCI layer must be buffered until the entire ACL packet has been received. Once the entire ACL packet has been received, the HCI layer will send the packet to the L2CAP layer. </p><div class="fragment"><div class="line"><span class="comment">/*************************************************************************************************/</span></div><div class="line"><span class="comment">/*************************************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___s_t_a_c_k___h_c_i___i_n_i_t___a_p_i.html#gac594463ca6d1730b01f1003d15de7539">HciSetMaxRxAclLen</a>(uint16_t len);</div></div><!-- fragment --><p>The MTU must be less than or equal to the MaxRxAclLen - L2C Header Length (4 bytes). </p><div class="fragment"><div class="line">/* if configured MTU size is larger than maximum RX PDU length */</div><div class="line">if (pAttCfg-&gt;mtu &gt; (HciGetMaxRxAclLen() - L2C_HDR_LEN))</div><div class="line">{</div><div class="line">  /* notify app about MTU misconfiguration */</div><div class="line">  attExecCallback(0, DM_ERROR_IND, 0, DM_ERR_ATT_RX_PDU_LEN_EXCEEDED, 0);</div><div class="line">}</div></div><!-- fragment --><p> The maximum MTU size is defined by the constant ATT_MAX_MTU, which has a value of 517. If you set the MTU to ATT_MAX_MTU or a value larger than any of the memory pools configured in <code>main.c</code> , you must create a new pool with a size of at least (new MTU size + 20) to allow for packet headers.</p>
<p>For exmaple to set MTU to ATT_MAX_MUT the relavent changes must look like this:</p><ul>
<li>periph_main.c <div class="fragment"><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___s_t_a_c_k___a_t_t___a_p_i.html#structatt_cfg__t">attCfg_t</a> periphAttCfg = {</div><div class="line">    15, <span class="comment">/* ATT server service discovery connection idle timeout in seconds */</span></div><div class="line">    <a class="code" href="group___s_t_a_c_k___a_t_t___a_p_i.html#ga0e37f7001d3231bb40b07765414d882b">ATT_MAX_MTU</a>, <span class="comment">/* desired ATT MTU */</span></div><div class="line">    <a class="code" href="group___s_t_a_c_k___a_t_t___a_p_i.html#ga5e17ea6a7e8b2085f1ec982d38796af5">ATT_MAX_TRANS_TIMEOUT</a>, <span class="comment">/* transcation timeout in seconds */</span></div><div class="line">    4 <span class="comment">/* number of queued prepare writes supported by server */</span></div><div class="line">};</div></div><!-- fragment --></li>
<li>stack_periph.c <div class="fragment"><div class="line"><span class="keywordtype">void</span> StackInitPeriph(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ..</div><div class="line"></div><div class="line">    handlerId = <a class="code" href="group___w_s_f___o_s___a_p_i.html#ga08cad44ca69d222a9ee06c947f33b996">WsfOsSetNextHandler</a>(<a class="code" href="group___s_t_a_c_k___e_v_e_n_t.html#gafcd17ed0115c52f2fc0f061833a58f95">SmpHandler</a>);</div><div class="line">    <a class="code" href="group___s_t_a_c_k___e_v_e_n_t.html#gae7569e38e0dd4a74b6833eafad33b0e4">SmpHandlerInit</a>(handlerId);</div><div class="line">    <a class="code" href="group___s_t_a_c_k___s_m_p___a_p_i.html#ga61ce2b237147234f4fbc1737495838a5">SmprInit</a>();</div><div class="line">    <a class="code" href="group___s_t_a_c_k___s_m_p___a_p_i.html#gaadd478794180f219147a5a7c5dc421c6">SmprScInit</a>();</div><div class="line">    <a class="code" href="group___s_t_a_c_k___h_c_i___i_n_i_t___a_p_i.html#gac594463ca6d1730b01f1003d15de7539">HciSetMaxRxAclLen</a>(<a class="code" href="group___s_t_a_c_k___a_t_t___a_p_i.html#ga0e37f7001d3231bb40b07765414d882b">ATT_MAX_MTU</a> + <a class="code" href="group___s_t_a_c_k___l2_c_a_p___a_p_i.html#gafca74102e91b60ba5d8cc5ece135ed8c">L2C_HDR_LEN</a>);</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">}</div></div><!-- fragment --></li>
<li>main.c <div class="fragment"><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___w_s_f___b_u_f___a_p_i.html#structwsf_buf_pool_desc__t">wsfBufPoolDesc_t</a> mainPoolDesc[] = </div><div class="line">{ { 16, 8 }, { 32, 4 }, { 192, 8 }, { 256, 8 } , {<a class="code" href="group___s_t_a_c_k___a_t_t___a_p_i.html#ga0e37f7001d3231bb40b07765414d882b">ATT_MAX_MTU</a> + 20} };</div></div><!-- fragment --> <h2>Callbacks</h2>
</li>
</ul>
<h2>Adding WSF events and handlers</h2>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Feb 19 2024 15:40:04 for Cordio by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
